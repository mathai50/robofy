# n8n AI Chat Integration Setup Guide

This document provides instructions for setting up n8n automation workflows to process leads generated by the AI chat system.

## Overview

The AI chat system generates leads with intelligent qualification and scoring. n8n workflows handle:
- Lead processing and enrichment
- CRM integration (existing webhook endpoint)
- Automated follow-up sequences
- Lead scoring and prioritization

## Required n8n Nodes

### 1. Webhook Trigger Node
**Purpose**: Receives leads from AI chat system

**Configuration**:
```json
{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ai-chat-lead",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "AI Chat Lead Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300]
    }
  ]
}
```

### 2. Set Node (Lead Data Processing)
**Purpose**: Structure and validate lead data

**Configuration**:
```json
{
  "nodes": [
    {
      "parameters": {
        "values": {
          "object": {
            "leadSource": "={{ $json.leadSource }}",
            "leadScore": "={{ $json.leadScore }}",
            "industry": "={{ $json.industry }}",
            "conversationSummary": "={{ $json.conversationSummary }}",
            "priority": "={{ $json.leadScore >= 80 ? 'high' : $json.leadScore >= 60 ? 'medium' : 'low' }}",
            "createdAt": "={{ new Date().toISOString() }}"
          }
        },
        "options": {}
      },
      "id": "set-lead-data",
      "name": "Process Lead Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [460, 300]
    }
  ]
}
```

### 3. CRM Integration Node (HTTP Request)
**Purpose**: Send lead to existing CRM system

**Configuration**:
```json
{
  "nodes": [
    {
      "parameters": {
        "method": "POST",
        "url": "https://ai.robofy.uk/webhook-test/a80eccd4-eb3f-418c-9a0c-bebdc40cbf46",
        "sendBody": true,
        "contentType": "application/json",
        "bodyParameters": {
          "event": "lead_generated",
          "leadData": "={{ $json }}",
          "source": "ai_chat_n8n",
          "timestamp": "={{ new Date().toISOString() }}"
        },
        "options": {}
      },
      "id": "crm-integration",
      "name": "Send to CRM",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [680, 300]
    }
  ]
}
```

### 4. Lead Scoring & Routing Node (IF Node)
**Purpose**: Route leads based on score and industry

**Configuration**:
```json
{
  "nodes": [
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.leadScore }}",
              "operation": "larger",
              "value2": 80
            }
          ]
        },
        "combineWith": "and"
      },
      "id": "high-score-route",
      "name": "High Score Leads",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [900, 200]
    }
  ]
}
```

### 5. Email Automation Node (Send Email)
**Purpose**: Send personalized follow-up emails

**High-Priority Lead Email**:
```json
{
  "nodes": [
    {
      "parameters": {
        "fromEmail": "your-email@yourdomain.com",
        "toEmail": "={{ $json.email }}",
        "subject": "={{ 'Thanks for your interest in ' + ($json.industry || 'our services') + ' - Next Steps' }}",
        "emailFormat": "html",
        "text": "={{ 'Hi ' + ($json.name || 'there') + ',\\n\\nThank you for your interest in our ' + ($json.industry || 'business') + ' solutions. Based on our conversation, I\\'d love to discuss how we can help transform your business.\\n\\nBest regards,\\nYour AI Assistant' }}"
      },
      "id": "high-priority-email",
      "name": "High Priority Follow-up",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 1,
      "position": [1120, 100]
    }
  ]
}
```

**Standard Lead Email**:
```json
{
  "nodes": [
    {
      "parameters": {
        "fromEmail": "your-email@yourdomain.com",
        "toEmail": "={{ $json.email }}",
        "subject": "={{ 'Thank you for your interest in ' + ($json.industry || 'our services') }}",
        "emailFormat": "html",
        "text": "={{ 'Hi ' + ($json.name || 'there') + ',\\n\\nThank you for exploring our services. We\\'ll be in touch soon with more information about how we can help your ' + ($json.industry || 'business') + ' succeed.\\n\\nBest regards,\\nThe Robofy Team' }}"
      },
      "id": "standard-email",
      "name": "Standard Follow-up",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 1,
      "position": [1120, 400]
    }
  ]
}
```

### 6. Task Creation Node (CRM Task)
**Purpose**: Create follow-up tasks for sales team

**Configuration**:
```json
{
  "nodes": [
    {
      "parameters": {
        "values": {
          "object": {
            "title": "={{ 'Follow up with ' + ($json.name || 'lead') + ' - ' + ($json.industry || 'general') + ' inquiry' }}",
            "description": "={{ 'Lead Score: ' + $json.leadScore + '\\nIndustry: ' + ($json.industry || 'Not specified') + '\\nSource: AI Chat\\n\\nConversation Summary: ' + ($json.conversationSummary || 'Not available') }}",
            "priority": "={{ $json.priority === 'high' ? 'urgent' : $json.priority === 'medium' ? 'normal' : 'low' }}",
            "dueDate": "={{ new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() }}", // 24 hours from now
            "assignee": "={{ $json.priority === 'high' ? 'senior_sales' : 'sales_team' }}"
          }
        }
      },
      "id": "create-task",
      "name": "Create Sales Task",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [1340, 300]
    }
  ]
}
```

## Complete Workflow Structure

```
Webhook Trigger → Set Lead Data → CRM Integration → IF (Lead Score)
    ↓ (High Score)                                           ↓ (Low Score)
High Priority Email → Create Urgent Task                Standard Email → Create Standard Task
```

## Environment Variables for n8n

Set these in your n8n environment:

```bash
# Email Configuration
SMTP_HOST=your-smtp-host.com
SMTP_PORT=587
SMTP_USER=your-email@yourdomain.com
SMTP_PASS=your-email-password

# CRM Configuration (if needed)
CRM_API_KEY=your-crm-api-key
CRM_WEBHOOK_URL=https://ai.robofy.uk/webhook-test/a80eccd4-eb3f-418c-9a0c-bebdc40cbf46

# Lead Scoring Thresholds
HIGH_PRIORITY_THRESHOLD=80
MEDIUM_PRIORITY_THRESHOLD=60
```

## Testing the Integration

1. **Test Webhook**: Use the AI chat widget to generate a lead and verify it reaches n8n
2. **Test Email**: Check that follow-up emails are sent correctly
3. **Test CRM Integration**: Verify leads appear in your CRM system
4. **Test Lead Scoring**: Create leads with different scores to test routing

## Monitoring and Analytics

The workflow includes error handling and logging:

- Failed webhook deliveries are logged
- Email delivery status is tracked
- Lead processing metrics are recorded
- Error notifications can be added via Slack/Teams webhooks

## Maintenance

- Monitor n8n execution logs regularly
- Update lead scoring thresholds based on conversion data
- Review and optimize email templates based on open rates
- Clean up old lead data periodically

## Support

For issues with the n8n integration:
1. Check n8n execution logs
2. Verify webhook URLs are accessible
3. Confirm API keys and credentials are valid
4. Test individual nodes in isolation

This setup provides a robust automation system that scales with your lead generation efforts while maintaining personalized follow-up processes.